<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeCatch - AR Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif; overflow: hidden;
        }
        .container { position: relative; background: #000; border-radius: 15px; overflow: hidden; }
        canvas { display: block; max-width: 100%; height: auto; }
        #video { display: none; }
        .info {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button onclick="location.reload()" style="position:fixed; bottom:20px; right:20px; z-index:100; padding:15px; border-radius:50px; border:none; background:gold; font-weight:bold;">
             ðŸ”„ RESTART
        </button>
        <canvas id="canvas"></canvas>
        <video id="video" playsinline autoplay muted style="width: 1px; height: 1px; opacity: 0.01; position: absolute;"></video>
        <div class="info">
            <h2>PokeCatch AR</h2>
            <p>Tap screen to start, then CLAP on the Pokemon!</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

    <script>
        let pokemonTimer;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');
        
        let isImgLoading = false; // Name matched here
        let catchCount = 0;
        let targetX = 300;
        let targetY = 200;

        const pokeImg = new Image();
        pokeImg.src = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png";

        async function fetchRandomPokemon() {
            isImgLoading = true;
            try {
                const randomId = Math.floor(Math.random() * 151) + 1;
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
                const data = await response.json();
                const nextImg = new Image();
                nextImg.src = data.sprites.other['official-artwork'].front_default;
                nextImg.onload = () => {
                    pokeImg.src = nextImg.src;
                    isImgLoading = false;
                };
            } catch (error) {
                console.error("API Error:", error);
                isImgLoading = false;
            }
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 0, // Better for POCO X3 Pro
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { if(pose) await pose.send({ image: video }); },
            width: 640, height: 480
        });

        async function startApp() {
            try {
                await camera.start();
                video.play();
                document.querySelector('.info p').innerText = "Stand back and wait for the camera!";
                respawnPokemon()
            } catch (err) { alert("Camera Error: " + err); }
        }

        document.body.addEventListener('click', startApp, { once: true });
        document.body.addEventListener('touchstart', startApp, { once: true });

        function onResults(results) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            if (results.poseLandmarks) {
                document.querySelector('.info').style.opacity = "0.2";
                const lh = results.poseLandmarks[19];
                const rh = results.poseLandmarks[20];
                const lx = lh.x * canvas.width;
                const ly = lh.y * canvas.height;
                const rx = rh.x * canvas.width;
                const ry = rh.y * canvas.height;

                const dist = Math.sqrt(Math.pow(rx - lx, 2) + Math.pow(ry - ly, 2));
                const isClapping = dist < 100; // Easier for presentation
                const avgX = (lx + rx) / 2;
                const avgY = (ly + ry) / 2;
                const distToTarget = Math.sqrt(Math.pow(avgX - targetX, 2) + Math.pow(avgY - targetY, 2));

                const size = 150;
                // Corrected the variable name here to match
                if(isImgLoading === false){
                    ctx.drawImage(pokeImg, targetX - size/2, targetY - size/2, size, size);
                }

                if (isClapping && distToTarget < 100 && !isImgLoading) {
                    catchCount++;
                    // Flash effect
                    ctx.fillStyle = "white";
                    ctx.fillRect(0,0, canvas.width, canvas.height);
                    
                    targetX = Math.random() * (canvas.width - 200) + 100;
                    targetY = Math.random() * (canvas.height - 200) + 100;
                    fetchRandomPokemon();
                }
                function respawnPokemon() {
    // 1. Clear any old timers so they don't double up
    clearTimeout(pokemonTimer);
    
    // 2. Move to a new spot
    targetX = Math.random() * (canvas.width - 200) + 100;
    targetY = Math.random() * (canvas.height - 200) + 100;
    
    // 3. Get a new Pokemon
    fetchRandomPokemon();
    
    // 4. Start the 3-second clock again for the new one!
    pokemonTimer = setTimeout(respawnPokemon, 3000); 
}

                ctx.fillStyle = isClapping ? "cyan" : "red";
                ctx.beginPath(); ctx.arc(lx, ly, 25, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(rx, ry, 25, 0, 7); ctx.fill();
                
                ctx.restore(); 
                ctx.fillStyle = "gold";
                ctx.font = "bold 40px Arial";
                ctx.fillText("CATCHES: " + catchCount, 50, 60);
            } else { ctx.restore(); }
        }
    </script>
</body>
</html>
