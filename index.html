<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PokeCatch AR - Final Build</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif; overflow: hidden;
        }
        .container { position: relative; background: #000; border-radius: 15px; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; object-fit: cover; }
        #video { display: none; }
        .info {
            position: absolute; top: 20px; left: 20px; color: white;
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 10px; z-index: 10;
        }
        #restartBtn {
            position: fixed; bottom: 20px; right: 20px; z-index: 100; 
            padding: 15px; border-radius: 50px; border: none; 
            background: gold; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="restartBtn" onclick="location.reload()">ðŸ”„ RESTART</button>
        <canvas id="canvas"></canvas>
        <video id="video" playsinline autoplay muted style="width: 1px; height: 1px; opacity: 0.01; position: absolute;"></video>
        <div class="info">
            <h2>PokeCatch AR</h2>
            <p id="status">Tap screen to start!</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('video');

        let startTime;
        let isImgLoading = false; 
        let catchCount = 0;
        let targetX = 300;
        let targetY = 200;
        let pokemonTimer;
        let missFlash = 0; // New timer for the red flash effect

        const pokeImg = new Image();
        pokeImg.src = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png";

        function respawnPokemon() {
            if (isImgLoading) return;
            
            missFlash = 10; // Trigger 10 frames of red flash

            targetX = Math.random() * (canvas.width - 200) + 100;
            targetY = Math.random() * (canvas.height - 200) + 100;
            fetchRandomPokemon();
        }

        async function fetchRandomPokemon() {
            isImgLoading = true;
            clearTimeout(pokemonTimer);

            try {
                const randomId = Math.floor(Math.random() * 151) + 1;
                const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
                const data = await response.json();
                
                const nextImg = new Image();
                nextImg.src = data.sprites.other['official-artwork'].front_default;
                
                nextImg.onload = () => {
                    pokeImg.src = nextImg.src;
                    isImgLoading = false;
                    startTime = Date.now();
                    pokemonTimer = setTimeout(respawnPokemon, 2000); 
                };
            } catch (error) {
                isImgLoading = false;
                pokemonTimer = setTimeout(respawnPokemon, 1000);
            }
        }

        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({
            modelComplexity: 0,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        pose.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => { await pose.send({ image: video }); },
            width: 640, height: 480
        });

        async function startApp() {
            try {
                document.getElementById('status').innerText = "AI Loading... Stand Back!";
                await camera.start();
                video.play();
                fetchRandomPokemon();
            } catch (err) { alert("Camera Error!"); }
        }

        document.body.addEventListener('click', startApp, { once: true });
        document.body.addEventListener('touchstart', startApp, { once: true });

        function onResults(results) {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            // DRAW MISS FLASH OVER VIDEO
            if (missFlash > 0) {
                ctx.fillStyle = `rgba(255, 0, 0, ${missFlash / 15})`;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                missFlash--;
            }

            if (results.poseLandmarks) {
                document.querySelector('.info').style.opacity = "0.2";
                
                const lh = results.poseLandmarks[19];
                const rh = results.poseLandmarks[20];
                
                const lx = lh.x * canvas.width;
                const ly = lh.y * canvas.height;
                const rx = rh.x * canvas.width;
                const ry = rh.y * canvas.height;

                const dist = Math.sqrt(Math.pow(rx - lx, 2) + Math.pow(ry - ly, 2));
                const isClapping = dist < 110; 
                
                const avgX = (lx + rx) / 2;
                const avgY = (ly + ry) / 2;
                const distToTarget = Math.sqrt(Math.pow(avgX - targetX, 2) + Math.pow(avgY - targetY, 2));

                // --- TIMER BAR ---
                if (!isImgLoading && startTime) {
                    let elapsed = Date.now() - startTime;
                    let barPercent = Math.max(0, (2000 - elapsed) / 2000);
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillRect(50, 80, canvas.width - 100, 15);
                    
                    if(barPercent > 0.5) ctx.fillStyle = "#00FF00";
                    else if(barPercent > 0.2) ctx.fillStyle = "#FFFF00";
                    else ctx.fillStyle = "#FF0000";
                    
                    ctx.fillRect(50, 80, (canvas.width - 100) * barPercent, 15);
                }

                // Draw Pokemon
                if(!isImgLoading) ctx.drawImage(pokeImg, targetX - 90, targetY - 90, 180, 180);

                // --- CATCH LOGIC ---
                if (isClapping && distToTarget < 110 && !isImgLoading) {
                    catchCount++;
                    if (navigator.vibrate) navigator.vibrate(50);
                    
                    // White catch flash
                    ctx.fillStyle = "white";
                    ctx.fillRect(0,0, canvas.width, canvas.height);
                    
                    targetX = Math.random() * (canvas.width - 200) + 100;
                    targetY = Math.random() * (canvas.height - 200) + 100;
                    fetchRandomPokemon(); 
                }

                // --- HAND TRACKER COLORS ---
                if (isClapping) ctx.fillStyle = "cyan";
                else if (distToTarget < 150) ctx.fillStyle = "yellow";
                else ctx.fillStyle = "red";

                ctx.beginPath(); ctx.arc(lx, ly, 20, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(rx, ry, 20, 0, 7); ctx.fill();
                
                ctx.restore(); 
                
                // UI TEXT
                ctx.fillStyle = "gold";
                ctx.font = "bold 40px Arial";
                ctx.shadowColor = "black";
                ctx.shadowBlur = 5;
                ctx.fillText("CATCHES: " + catchCount, 50, 60);
            } else {
                ctx.restore();
            }
        }
    </script>
</body>
</html>
